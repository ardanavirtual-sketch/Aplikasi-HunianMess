<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Mess - Sistem Manajemen Hunian Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --ocean-dark: #071927;
            --ocean-surface: #0b253a;
            --ocean-accent: #0ea5e9;
            --ocean-gradient: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            --ocean-gradient-dark: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--ocean-dark);
            color: #e2e8f0;
            margin: 0;
            overflow-x: hidden;
        }

        /* Glassmorphism Effects */
        .glass-panel {
            background: rgba(11, 37, 58, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .glass-card {
            background: rgba(11, 37, 58, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(14, 165, 233, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(14, 165, 233, 0.5); }

        /* Sidebar */
        #sidebar {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 280px;
        }
        #sidebar.collapsed { width: 80px; }
        #sidebar.collapsed .nav-text, 
        #sidebar.collapsed .sidebar-header-text,
        #sidebar.collapsed .sidebar-footer-content { display: none; }
        #sidebar.collapsed .nav-link { justify-content: center; padding-left: 0; padding-right: 0; }

        /* Navigation */
        .nav-link.active {
            background: var(--ocean-gradient);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(14, 165, 233, 0.4);
        }

        .nav-link.active i {
            color: white;
        }

        /* Database Table */
        .database-table {
            border-collapse: separate;
            border-spacing: 0;
            width: max-content;
            min-width: 100%;
        }
        .database-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #0b253a;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 10px;
            font-weight: 800;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 16px 24px;
        }
        .database-table td {
            white-space: nowrap;
            padding: 12px 24px;
            font-size: 11px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .sticky-col-left {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #071927;
            box-shadow: 4px 0 10px rgba(0,0,0,0.2);
        }
        
        .sticky-col-right {
            position: sticky;
            right: 0;
            z-index: 5;
            background: #071927;
            border-left: 1px solid rgba(255,255,255,0.1);
            box-shadow: -4px 0 10px rgba(0,0,0,0.2);
        }

        /* Modals */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        /* Form Elements */
        .input-field {
            background: rgba(7, 25, 39, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .select-field {
            background: rgba(7, 25, 39, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
        }

        /* Buttons */
        .btn-primary {
            background: var(--ocean-gradient);
            color: white;
            font-weight: 800;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        /* Animations */
        .animate-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Statistics Cards */
        .stat-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Table Hover Effects */
        .table-row-hover:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Validation */
        .required-field::after {
            content: " *";
            color: #ef4444;
        }

        .validation-success {
            border-color: #10b981 !important;
            background-color: rgba(16, 185, 129, 0.05) !important;
        }

        .validation-error {
            border-color: #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }

        /* Drag & Drop Area */
        .drag-drop-area {
            border: 2px dashed rgba(14, 165, 233, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            background: rgba(14, 165, 233, 0.05);
        }

        .drag-drop-area.dragover {
            border-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            transform: scale(1.02);
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #0ea5e9;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
        }

        .toast-error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
        }

        .toast-info {
            background: rgba(14, 165, 233, 0.1);
            border-left: 4px solid #0ea5e9;
        }
        
        /* Grade Badges */
        .grd-badge {
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
        }
        
        .grd-1 { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .grd-2 { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .grd-3 { background-color: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .grd-4 { background-color: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .grd-vendor { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--ocean-gradient);
            transition: width 0.3s ease;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            margin-bottom: 8px;
            transition: all 0.3s;
            z-index: 2;
        }
        
        .step.active .step-number {
            background: var(--ocean-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
        
        .step-line {
            position: absolute;
            top: 18px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }
        
        .step.completed .step-line {
            background: #10b981;
        }
        
        .step-label {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.05em;
        }
        
        .step.active .step-label {
            color: #0ea5e9;
        }
        
        .step.completed .step-label {
            color: #10b981;
        }

        /* Import Progress */
        .import-progress {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .progress-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        
        .progress-stat-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .progress-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #94a3b8;
            letter-spacing: 0.05em;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .status-success .status-dot {
            background: #10b981;
        }
        
        .status-processing {
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
        }
        
        .status-processing .status-dot {
            background: #0ea5e9;
            animation: pulse 2s infinite;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .status-error .status-dot {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Advanced Filter Panel */
        .filter-panel {
            background: rgba(11, 37, 58, 0.6);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .filter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .filter-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .filter-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }
        
        .filter-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            animation: slideInRight 0.3s ease-out;
        }

        /* Data Preview Table */
        .preview-table-container {
            max-height: 400px;
            overflow: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(7, 25, 39, 0.8);
        }
        
        .preview-table {
            width: 100%;
            font-size: 11px;
        }
        
        .preview-table th {
            background: #0b253a;
            padding: 12px 16px;
            text-transform: uppercase;
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .preview-table td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .preview-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .data-row-valid {
            border-left: 4px solid #10b981;
        }
        
        .data-row-invalid {
            border-left: 4px solid #ef4444;
        }
        
        .data-row-update {
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="flex h-screen">

    <div id="toast-container" class="fixed top-6 right-6 z-[110] flex flex-col gap-3"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/70 z-[120] flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mb-4 mx-auto"></div>
            <p class="text-white font-bold">Memproses data...</p>
            <p class="text-slate-400 text-sm mt-2" id="loading-detail">Harap tunggu</p>
        </div>
    </div>

    <!-- Hidden Input for Import -->
    <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls, .csv">

    <!-- MODAL IMPORT ADVANCED -->
    <div id="modal-import-advanced" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeImportAdvancedModal()"></div>
        <div class="glass-panel w-full max-w-5xl max-h-[90vh] rounded-[32px] shadow-2xl overflow-hidden relative flex flex-col animate-in zoom-in-95 duration-300">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div>
                    <h3 class="text-xl font-black text-white">Import Data Excel - Advanced</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Import data massal dengan validasi otomatis</p>
                </div>
                <button onclick="closeImportAdvancedModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="x" class="text-slate-400"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step completed" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-line"></div>
                        <div class="step-label">Upload File</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-line"></div>
                        <div class="step-label">Mapping Kolom</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-line"></div>
                        <div class="step-label">Preview Data</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-line"></div>
                        <div class="step-label">Konfirmasi</div>
                    </div>
                </div>

                <!-- Step 1: Upload File -->
                <div id="step1-content" class="step-content">
                    <div id="drag-drop-area" class="drag-drop-area cursor-pointer mb-6">
                        <i data-lucide="upload-cloud" class="w-16 h-16 text-sky-400 mb-4"></i>
                        <h4 class="text-lg font-bold text-white mb-2">Upload File Excel</h4>
                        <p class="text-slate-400 text-sm mb-4">Seret file atau klik untuk memilih file Excel (.xlsx, .xls, .csv)</p>
                        <button onclick="document.getElementById('importFile').click()" class="btn-secondary inline-flex items-center gap-2">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> PILIH FILE
                        </button>
                        <p class="text-[10px] text-slate-500 mt-4">Maksimal ukuran file: 10MB</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-6 rounded-2xl">
                            <h5 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i> Template Format
                            </h5>
                            <ul class="text-[10px] text-slate-300 space-y-2">
                                <li>• Kolom wajib: <strong>NIK, NAMA, GRD, NO KAMAR</strong></li>
                                <li>• Format NIK: <strong>Huruf pertama harus A-Z</strong></li>
                                <li>• GRD: <strong>1, 2, 3, 4, vendor</strong></li>
                                <li>• Format tanggal: <strong>YYYY-MM-DD</strong></li>
                                <li>• Status Kamar: <strong>TERISI, TERSEDIA, RUSAK, DIPERBAIKI</strong></li>
                                <li>• Lokasi Hunian: <strong>P2 SURYA RESIDANCE, MENTARI, PELANGI</strong></li>
                            </ul>
                        </div>
                        
                        <div class="glass-card p-6 rounded-2xl">
                            <h5 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4 text-sky-400"></i> Unduh Template
                            </h5>
                            <p class="text-slate-400 text-sm mb-4">Template Excel dengan format yang sudah benar</p>
                            <button onclick="downloadTemplate()" class="btn-secondary w-full flex items-center justify-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> UNDUH TEMPLATE
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="next-step1" class="btn-primary" onclick="goToStep(2)" disabled>
                            <i data-lucide="arrow-right" class="w-4 h-4 mr-2"></i> LANJUT KE MAPPING
                        </button>
                    </div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="step2-content" class="step-content hidden">
                    <h4 class="text-lg font-bold text-white mb-4">Mapping Kolom Excel ke Database</h4>
                    <p class="text-slate-400 text-sm mb-6">Pilih kolom dari file Excel yang sesuai dengan field database</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="column-mapping-container">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button class="btn-secondary" onclick="goToStep(1)">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> KEMBALI
                        </button>
                        <button id="next-step2" class="btn-primary" onclick="goToStep(3)">
                            <i data-lucide="arrow-right" class="w-4 h-4 mr-2"></i> PREVIEW DATA
                        </button>
                    </div>
                </div>

                <!-- Step 3: Data Preview -->
                <div id="step3-content" class="step-content hidden">
                    <h4 class="text-lg font-bold text-white mb-4">Preview Data Import</h4>
                    <p class="text-slate-400 text-sm mb-6">Review data sebelum diupload ke database</p>
                    
                    <!-- Import Progress Stats -->
                    <div id="import-progress-stats" class="import-progress hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h5 class="text-sm font-bold text-white">Status Import</h5>
                                <p class="text-[10px] text-slate-400" id="import-status-text">Mempersiapkan data...</p>
                            </div>
                            <div class="status-indicator status-processing">
                                <div class="status-dot"></div>
                                <span>Processing</span>
                            </div>
                        </div>
                        
                        <div class="progress-bar">
                            <div id="import-progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                        
                        <div id="progress-stats" class="progress-stats hidden">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Data Preview Table -->
                    <div class="preview-table-container">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>NIK</th>
                                    <th>NAMA</th>
                                    <th>GRD</th>
                                    <th>NO KAMAR</th>
                                    <th>STATUS</th>
                                    <th>VALIDASI</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table-body-advanced">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Validation Summary -->
                    <div id="validation-summary" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button class="btn-secondary" onclick="goToStep(2)">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> KEMBALI
                        </button>
                        <button id="next-step3" class="btn-primary" onclick="validateAndProceed()">
                            <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> VALIDASI & LANJUT
                        </button>
                    </div>
                </div>

                <!-- Step 4: Confirmation -->
                <div id="step4-content" class="step-content hidden">
                    <h4 class="text-lg font-bold text-white mb-4">Konfirmasi Import</h4>
                    <p class="text-slate-400 text-sm mb-6">Konfirmasi untuk memulai proses import data ke database</p>
                    
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <h5 class="text-sm font-bold text-white mb-4">Ringkasan Import</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="import-summary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                    
                    <div class="glass-card p-6 rounded-2xl mb-6">
                        <h5 class="text-sm font-bold text-white mb-3">Opsi Import</h5>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="option-update-existing" checked class="w-4 h-4 rounded">
                                <label for="option-update-existing" class="text-sm text-slate-300">Update data yang sudah ada (berdasarkan NIK)</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="option-skip-invalid" checked class="w-4 h-4 rounded">
                                <label for="option-skip-invalid" class="text-sm text-slate-300">Lewati data yang tidak valid</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="option-send-notification" class="w-4 h-4 rounded">
                                <label for="option-send-notification" class="text-sm text-slate-300">Kirim notifikasi setelah import selesai</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between">
                        <button class="btn-secondary" onclick="goToStep(3)">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> KEMBALI
                        </button>
                        <button id="confirm-import" class="btn-primary" onclick="startImportProcess()">
                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i> PROSES IMPORT
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FORM (TAMBAH & EDIT) -->
    <div id="modal-form" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div class="glass-panel w-full max-w-4xl max-h-[90vh] rounded-[32px] shadow-2xl overflow-hidden relative flex flex-col animate-in zoom-in-95 duration-300">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div>
                    <h3 id="modal-title" class="text-xl font-black text-white">Tambah Data Karyawan</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Lengkapi data penghuni mess</p>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors">
                    <i data-lucide="x" class="text-slate-400"></i>
                </button>
            </div>
            
            <form id="employeeForm" class="flex-1 overflow-y-auto p-8 custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="saveData(event)">
                <input type="hidden" name="id" id="edit-id">
                
                <!-- Kolom Kiri: Data Pribadi -->
                <div class="space-y-6">
                    <h4 class="text-sm font-bold text-sky-400 border-b border-white/10 pb-2 mb-2">DATA PRIBADI</h4>
                    
                    <div class="form-group">
                        <label class="form-label required-field">NIK</label>
                        <input type="text" name="nik" id="field-nik" required 
                               class="input-field w-full"
                               pattern="^[A-Za-z][A-Za-z0-9]{1,19}$" 
                               title="NIK harus dimulai dengan huruf, diikuti kombinasi huruf dan angka (2-20 karakter)"
                               onblur="validateNIK(this)"
                               oninput="formatNIK(this)">
                        <div id="nik-hint" class="text-[10px] text-slate-500 mt-1 hidden">
                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> Contoh: A12345, EMP001, KRY1001
                        </div>
                        <div id="nik-error" class="text-[10px] text-rose-500 mt-1 hidden"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required-field">Nama Lengkap</label>
                        <input type="text" name="nama" id="field-nama" required 
                               class="input-field w-full">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label required-field">Gender</label>
                            <select name="gender" id="field-gender" required 
                                    class="select-field w-full">
                                <option value="">Pilih Gender</option>
                                <option value="LAKI-LAKI">LAKI-LAKI</option>
                                <option value="PEREMPUAN">PEREMPUAN</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required-field">GRD (Grade)</label>
                            <select name="grd" id="field-grd" required 
                                    class="select-field w-full">
                                <option value="">Pilih GRD</option>
                                <option value="1">1 - Golongan 1</option>
                                <option value="2">2 - Golongan 2</option>
                                <option value="3">3 - Golongan 3</option>
                                <option value="4">4 - Golongan 4 UP</option>
                                <option value="vendor">Vendor & Kontraktor</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Golongan Detail</label>
                        <select name="gol" id="field-gol" 
                                class="select-field w-full">
                            <option value="">Pilih Golongan Detail</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4A">4A</option>
                            <option value="4B">4B</option>
                            <option value="5">5</option>
                            <option value="M">M</option>
                            <option value="VENDOR">VENDOR</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Jabatan</label>
                        <input type="text" name="jabatan" id="field-jabatan" 
                               class="input-field w-full">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <input type="text" name="department" id="field-department" 
                               class="input-field w-full">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Perusahaan</label>
                        <select name="perusahaan" id="field-perusahaan" 
                                class="select-field w-full">
                            <option value="">Pilih Perusahaan</option>
                            <option value="PT. HJF">PT. HJF</option>
                            <option value="PT. INKA">PT. INKA</option>
                            <option value="PT. KAI">PT. KAI</option>
                            <option value="VENDOR">VENDOR LAINNYA</option>
                        </select>
                    </div>
                </div>

                <!-- Kolom Kanan: Data Hunian -->
                <div class="space-y-6">
                    <h4 class="text-sm font-bold text-emerald-400 border-b border-white/10 pb-2 mb-2">DATA HUNIAN</h4>
                    
                    <div class="form-group">
                        <label class="form-label required-field">Lokasi Hunian</label>
                        <select name="lokasi_hunian" id="field-lokasi_hunian" required 
                                class="select-field w-full">
                            <option value="">Pilih Lokasi</option>
                            <option value="P2 SURYA RESIDANCE">P2 SURYA RESIDANCE</option>
                            <option value="MENTARI">MENTARI</option>
                            <option value="PELANGI">PELANGI</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <div class="form-group">
                            <label class="form-label">Floor</label>
                            <select name="floor" id="field-floor" 
                                    class="select-field w-full">
                                <option value="">Pilih Floor</option>
                                <option value="Lantai Bawah">Lantai Bawah</option>
                                <option value="Lantai Atas">Lantai Atas</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Block</label>
                            <input type="text" name="block" id="field-block" 
                                   class="input-field w-full"
                                   placeholder="Masukkan Block">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required-field">No Kamar</label>
                            <input type="text" name="no_kamar" id="field-no_kamar" required 
                                   class="input-field w-full">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fasilitas</label>
                        <select name="fasilitas" id="field-fasilitas" 
                                class="select-field w-full">
                            <option value="">Pilih Fasilitas</option>
                            <option value="CR">CR</option>
                            <option value="NR">NR</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Point of Hire</label>
                        <input type="text" name="point_of_hire" id="field-point_of_hire" 
                               class="input-field w-full">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status Kamar</label>
                        <select name="status_kamar" id="field-status_kamar" 
                                class="select-field w-full">
                            <option value="TERISI">TERISI</option>
                            <option value="TERSEDIA">TERSEDIA</option>
                            <option value="RUSAK">RUSAK</option>
                            <option value="DIPERBAIKI">DIPERBAIKI</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Tgl Masuk Kerja</label>
                            <input type="date" name="tanggal_masuk_kerja" id="field-tanggal_masuk_kerja" 
                                   class="input-field w-full"
                                   max="<?php echo date('Y-m-d'); ?>">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tgl Masuk Mess</label>
                            <input type="date" name="tanggal_masuk_mess_hunian_p2" id="field-tanggal_masuk_mess_hunian_p2" 
                                   class="input-field w-full"
                                   max="<?php echo date('Y-m-d'); ?>">
                        </div>
                    </div>
                </div>

                <!-- Tombol Aksi -->
                <div class="md:col-span-2 pt-6 border-t border-white/5 flex gap-4">
                    <button type="submit" class="btn-primary flex-1">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> SIMPAN DATA
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 inline mr-2"></i> BATAL
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-[#091f30] border-r border-white/5 flex flex-col shrink-0 relative">
        <button onclick="toggleSidebar()" class="absolute -right-3 top-10 bg-sky-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-lg z-50 hover:scale-110 transition-transform">
            <i id="toggle-icon" data-lucide="chevron-left" class="w-4 h-4"></i>
        </button>

        <div class="p-6 mb-4 flex items-center gap-4">
            <div class="bg-gradient-to-br from-sky-500 to-blue-600 min-w-[48px] h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-sky-900/40">
                <i data-lucide="waves" class="text-white w-7 h-7"></i>
            </div>
            <div class="sidebar-header-text overflow-hidden">
                <h1 class="text-xl font-extrabold tracking-tight text-white leading-tight">OCEAN<span class="text-sky-400">MESS</span></h1>
                <span class="text-[9px] font-bold text-sky-500/80 tracking-[0.2em] uppercase">Enterprise P2</span>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar">
            <div class="mb-6">
                <p class="sidebar-header-text text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] mb-3 px-4">Menu Utama</p>
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-link w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    <span class="nav-text font-bold text-sm">Dashboard</span>
                </button>
                <button onclick="switchTab('data-karyawan-keseluruhan')" id="nav-data-karyawan-keseluruhan" class="nav-link w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="nav-text font-bold text-sm">Data Karyawan Keseluruhan</span>
                </button>
                <button onclick="switchTab('data-karyawan')" id="nav-data-karyawan" class="nav-link w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span class="nav-text font-bold text-sm">Data Karyawan</span>
                </button>
                <button onclick="switchTab('manajemen-data')" id="nav-manajemen-data" class="nav-link w-full flex items-center gap-3 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="nav-text font-bold text-sm">Manajemen Data</span>
                </button>
            </div>

            <div class="mb-6">
                <p class="sidebar-header-text text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] mb-3 px-4">Filter Golongan (GRD)</p>
                <div class="space-y-1">
                    <button onclick="switchCategory('1')" id="nav-gol1" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span class="nav-text font-bold text-xs flex-1 text-left">Golongan 1 (GRD 1)</span>
                        <span id="count-gol1" class="text-[9px] bg-sky-500/20 text-sky-400 px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="switchCategory('2')" id="nav-gol2" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span class="nav-text font-bold text-xs flex-1 text-left">Golongan 2 (GRD 2)</span>
                        <span id="count-gol2" class="text-[9px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="switchCategory('3')" id="nav-gol3" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span class="nav-text font-bold text-xs flex-1 text-left">Golongan 3 (GRD 3)</span>
                        <span id="count-gol3" class="text-[9px] bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="switchCategory('4')" id="nav-gol4" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        <span class="nav-text font-bold text-xs flex-1 text-left">Golongan 4 UP (GRD 4)</span>
                        <span id="count-gol4" class="text-[9px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button onclick="switchCategory('vendor')" id="nav-vendor" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5">
                        <i data-lucide="briefcase" class="w-4 h-4"></i>
                        <span class="nav-text font-bold text-xs flex-1 text-left">Vendor & Kontrak</span>
                        <span id="count-vendor" class="text-[9px] bg-rose-500/20 text-rose-400 px-2 py-0.5 rounded-full">0</span>
                    </button>
                </div>
            </div>
        </nav>

        <div class="p-4 sidebar-footer-content">
            <div class="text-[10px] text-slate-500 text-center">
                <p>© 2024 OceanMess</p>
                <p>v2.2.0</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-[#071927]">
        <!-- Header Utama -->
        <header class="h-20 border-b border-white/5 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-4">
                <div id="page-icon" class="w-10 h-10 bg-sky-500/10 text-sky-500 rounded-xl flex items-center justify-center">
                    <i data-lucide="layout-grid"></i>
                </div>
                <div>
                    <h2 id="page-title" class="text-xl font-black text-white">Dashboard</h2>
                    <p id="page-subtitle" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Sistem Manajemen Mess Terintegrasi</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative hidden sm:block">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>
                    <input type="text" id="globalSearch" placeholder="Cari NIK, Nama, atau No Kamar..." 
                        class="input-field pl-12 w-72 placeholder:text-slate-600"
                        oninput="handleGlobalSearch()">
                </div>
                <button onclick="openImportAdvancedModal()" class="btn-primary flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">IMPORT DATA</span>
                </button>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-hidden relative">
            
            <!-- TAB DASHBOARD -->
            <div id="tab-dashboard" class="absolute inset-0 p-8 overflow-y-auto custom-scrollbar animate-in fade-in duration-500">
                <!-- Statistik Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass-panel p-6 rounded-3xl border-l-4 border-sky-500 stat-card">
                        <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Total Penghuni</p>
                        <h3 id="stat-total" class="text-3xl font-black mt-2 text-white">0</h3>
                        <div class="flex items-center mt-3">
                            <i data-lucide="users" class="w-4 h-4 text-sky-400 mr-2"></i>
                            <span class="text-[10px] text-slate-500">Semua golongan</span>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-3xl border-l-4 border-emerald-500 stat-card">
                        <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Kamar Terisi</p>
                        <h3 id="stat-terisi" class="text-3xl font-black mt-2 text-emerald-400">0</h3>
                        <div class="flex items-center mt-3">
                            <i data-lucide="home" class="w-4 h-4 text-emerald-400 mr-2"></i>
                            <span class="text-[10px] text-slate-500">Penghuni aktif</span>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-3xl border-l-4 border-amber-500 stat-card">
                        <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Kamar Tersedia</p>
                        <h3 id="stat-avail" class="text-3xl font-black mt-2 text-amber-400">0</h3>
                        <div class="flex items-center mt-3">
                            <i data-lucide="door-open" class="w-4 h-4 text-amber-400 mr-2"></i>
                            <span class="text-[10px] text-slate-500">Kamar kosong</span>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-3xl border-l-4 border-purple-500 stat-card">
                        <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Total Mess</p>
                        <h3 id="stat-mess" class="text-3xl font-black mt-2 text-white">0</h3>
                        <div class="flex items-center mt-3">
                            <i data-lucide="building" class="w-4 h-4 text-purple-400 mr-2"></i>
                            <span class="text-[10px] text-slate-500">Lokasi hunian</span>
                        </div>
                    </div>
                </div>

                <!-- Aksi Cepat -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gradient-to-br from-sky-600 to-sky-900 p-8 rounded-[32px] relative overflow-hidden group">
                        <div class="relative z-10">
                            <h3 class="text-2xl font-black text-white mb-2">Ringkasan Database</h3>
                            <p class="text-sky-100/70 text-xs mb-6 max-w-md">Sistem manajemen hunian mess dengan kapasitas 20.000 karyawan. Data terupdate secara real-time.</p>
                            <div class="flex items-center gap-2 text-sm">
                                <i data-lucide="database" class="w-4 h-4 text-sky-300"></i>
                                <span class="text-sky-300">Status: <span id="db-status" class="font-bold">Connected</span></span>
                            </div>
                        </div>
                        <i data-lucide="database" class="absolute right-[-20px] bottom-[-20px] w-48 h-48 text-white/10 rotate-12 group-hover:scale-110 transition-transform duration-700"></i>
                    </div>
                    <div class="glass-panel p-8 rounded-[32px] flex flex-col justify-center border-dashed border-2 border-white/10">
                        <h3 class="text-xl font-black text-white mb-2">Informasi Kapasitas</h3>
                        <p class="text-slate-400 text-xs mb-4">Ringkasan hunian Mess P2.</p>
                        <div class="w-full bg-white/5 h-3 rounded-full overflow-hidden">
                            <div id="capacity-bar" class="bg-gradient-to-r from-sky-500 to-blue-500 h-full w-[0%] transition-all duration-1000"></div>
                        </div>
                        <div class="flex justify-between mt-3 text-[10px] font-bold text-slate-500">
                            <span>0 PENGHUNI</span>
                            <span id="capacity-text">0% TERPAKAI</span>
                            <span>20.000 KAPASITAS</span>
                        </div>
                    </div>
                </div>

                <!-- Statistik Golongan berdasarkan GRD -->
                <div class="glass-panel p-8 rounded-[32px] mb-8">
                    <h3 class="text-xl font-black text-white mb-6">Distribusi Golongan (GRD)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <div class="text-2xl font-black text-sky-400" id="gol1-count">0</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">GRD 1</div>
                            <div class="text-[8px] text-slate-500">Golongan 1</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <div class="text-2xl font-black text-emerald-400" id="gol2-count">0</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">GRD 2</div>
                            <div class="text-[8px] text-slate-500">Golongan 2</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <div class="text-2xl font-black text-amber-400" id="gol3-count">0</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">GRD 3</div>
                            <div class="text-[8px] text-slate-500">Golongan 3</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <div class="text-2xl font-black text-purple-400" id="gol4-count">0</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">GRD 4</div>
                            <div class="text-[8px] text-slate-500">Gol 4 UP</div>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <div class="text-2xl font-black text-rose-400" id="vendor-count">0</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Vendor</div>
                            <div class="text-[8px] text-slate-500">Kontraktor</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB DATA KARYAWAN KESELURUHAN -->
            <div id="tab-data-karyawan-keseluruhan" class="hidden absolute inset-0 flex flex-col animate-in slide-in-from-right-4 duration-500">
                <!-- Sub-Header Bar -->
                <div class="px-8 py-4 bg-[#0b253a]/30 border-b border-white/5 flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <span id="data-count-badge-all" class="bg-gradient-to-r from-sky-500 to-blue-500 text-white px-3 py-1 rounded-full text-[10px] font-black">0 DATA</span>
                        <h4 class="text-sm font-black text-white uppercase tracking-wider">DATA KARYAWAN KESELURUHAN</h4>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="exportAllData()" class="btn-secondary text-[10px] flex items-center gap-2">
                            <i data-lucide="download" class="w-3 h-3"></i> EXPORT
                        </button>
                        <button onclick="openModal()" class="btn-primary text-[10px] flex items-center gap-2">
                            <i data-lucide="plus" class="w-3 h-3"></i> TAMBAH
                        </button>
                    </div>
                </div>

                <!-- Advanced Filter Panel -->
                <div class="filter-panel mx-8 mt-4">
                    <div class="filter-header">
                        <h5 class="text-sm font-bold text-white flex items-center gap-2">
                            <i data-lucide="filter" class="w-4 h-4"></i> FILTER LANJUTAN
                        </h5>
                        <button id="toggle-filter" class="filter-toggle" onclick="toggleAdvancedFilter()">
                            <i data-lucide="chevron-down" class="w-3 h-3"></i> TAMPILKAN FILTER
                        </button>
                    </div>
                    
                    <div id="advanced-filter-content" class="filter-content hidden">
                        <div>
                            <label class="form-label">Lokasi Hunian</label>
                            <select id="filterAllLokasi" class="select-field w-full text-[11px] py-1.5">
                                <option value="">Semua Lokasi</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">GRD</label>
                            <select id="filterAllGrd" class="select-field w-full text-[11px] py-1.5">
                                <option value="">Semua GRD</option>
                                <option value="1">GRD 1</option>
                                <option value="2">GRD 2</option>
                                <option value="3">GRD 3</option>
                                <option value="4">GRD 4</option>
                                <option value="vendor">Vendor</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Perusahaan</label>
                            <select id="filterAllPerusahaan" class="select-field w-full text-[11px] py-1.5">
                                <option value="">Semua Perusahaan</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Status Kamar</label>
                            <select id="filterAllStatus" class="select-field w-full text-[11px] py-1.5">
                                <option value="">Semua Status</option>
                                <option value="TERISI">TERISI</option>
                                <option value="TERSEDIA">TERSEDIA</option>
                                <option value="RUSAK">RUSAK</option>
                                <option value="DIPERBAIKI">DIPERBAIKI</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Tanggal Masuk</label>
                            <input type="month" id="filterAllTanggal" class="input-field w-full text-[11px] py-1.5">
                        </div>
                    </div>
                    
                    <div id="quick-filter-bar" class="flex items-center gap-3 mt-4">
                        <button onclick="applyAllFilters()" class="btn-primary text-[10px] py-2 px-4">
                            <i data-lucide="filter" class="w-3 h-3 mr-1"></i> TERAPKAN FILTER
                        </button>
                        <button onclick="resetAllFilters()" class="btn-secondary text-[10px] py-2 px-4">
                            <i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i> RESET
                        </button>
                        <div class="flex-1"></div>
                        <div class="text-[10px] text-slate-400">
                            <span id="filtered-count">0</span> dari <span id="total-count">0</span> data ditampilkan
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="flex-1 overflow-auto custom-scrollbar bg-[#071927] mx-4 my-4">
                    <table class="database-table">
                        <thead class="text-slate-400">
                            <tr>
                                <th class="sticky-col-left">NIK</th>
                                <th>NAMA</th>
                                <th>GENDER</th>
                                <th>DEPARTMENT</th>
                                <th>GRD</th>
                                <th>GOL</th>
                                <th>JABATAN</th>
                                <th>FASILITAS</th>
                                <th class="text-sky-400">POINT OF HIRE</th>
                                <th>TGL MASUK KERJA</th>
                                <th>PERUSAHAAN</th>
                                <th>LOKASI HUNIAN</th>
                                <th>FLOOR</th>
                                <th>BLOCK</th>
                                <th class="text-emerald-400">NO KAMAR</th>
                                <th>STATUS KAMAR</th>
                                <th class="text-amber-400">TGL MASUK MESS</th>
                                <th class="sticky-col-right text-center">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-all">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-8 py-4 border-t border-white/5 flex items-center justify-between">
                    <div class="text-[10px] text-slate-400">
                        Menampilkan <span id="page-start">1</span>-<span id="page-end">10</span> dari <span id="total-items">0</span> data
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="previousPage()" class="p-2 rounded-lg hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed" id="prev-page">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <div class="flex items-center gap-1" id="page-numbers">
                            <!-- Page numbers will be generated here -->
                        </div>
                        <button onclick="nextPage()" class="p-2 rounded-lg hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed" id="next-page">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400">Data per halaman:</span>
                        <select id="page-size" class="input-field text-[10px] py-1 px-2" onchange="changePageSize()">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- TAB DATA KARYAWAN -->
            <div id="tab-data-karyawan" class="hidden absolute inset-0 flex flex-col animate-in slide-in-from-right-4 duration-500">
                <!-- Sub-Header Bar -->
                <div class="px-8 py-4 bg-[#0b253a]/30 border-b border-white/5 flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <span id="data-count-badge" class="bg-gradient-to-r from-sky-500 to-blue-500 text-white px-3 py-1 rounded-full text-[10px] font-black">0 DATA</span>
                        <h4 id="current-view-name" class="text-sm font-black text-white uppercase tracking-wider">DATABASE KARYAWAN</h4>
                    </div>
                </div>

                <!-- FILTER BAR -->
                <div class="px-8 py-3 bg-[#0b253a]/20 border-b border-white/5 flex items-center gap-4 shrink-0">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div>
                            <label class="form-label">Lokasi Hunian</label>
                            <select id="filterLokasi" onchange="renderTable()" class="select-field text-[11px] py-1.5">
                                <option value="">Semua Lokasi</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Block</label>
                            <input type="text" id="filterBlock" oninput="renderTable()" placeholder="Cari block..." 
                                   class="input-field text-[11px] py-1.5">
                        </div>
                        <div>
                            <label class="form-label">No Kamar</label>
                            <input type="text" id="filterKamar" oninput="renderTable()" placeholder="Cari no kamar..." 
                                   class="input-field text-[11px] py-1.5">
                        </div>
                        <div>
                            <label class="form-label">Status Kamar</label>
                            <select id="filterStatusKamar" onchange="renderTable()" class="select-field text-[11px] py-1.5">
                                <option value="">Semua Status</option>
                                <option value="TERISI">TERISI</option>
                                <option value="TERSEDIA">TERSEDIA</option>
                                <option value="RUSAK">RUSAK</option>
                                <option value="DIPERBAIKI">DIPERBAIKI</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Perusahaan</label>
                            <select id="filterPerusahaan" onchange="renderTable()" class="select-field text-[11px] py-1.5">
                                <option value="">Semua Perusahaan</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <button onclick="resetTableFilters()" class="btn-secondary text-[10px]">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="flex-1 overflow-auto custom-scrollbar bg-[#071927]">
                    <table class="database-table">
                        <thead class="text-slate-400">
                            <tr>
                                <th class="sticky-col-left">NIK</th>
                                <th>NAMA</th>
                                <th>GENDER</th>
                                <th>DEPARTMENT</th>
                                <th>GRD</th>
                                <th>GOL</th>
                                <th>JABATAN</th>
                                <th>FASILITAS</th>
                                <th class="text-sky-400">POINT OF HIRE</th>
                                <th>TGL MASUK KERJA</th>
                                <th>PERUSAHAAN</th>
                                <th>LOKASI HUNIAN</th>
                                <th>FLOOR</th>
                                <th>BLOCK</th>
                                <th class="text-emerald-400">NO KAMAR</th>
                                <th>STATUS KAMAR</th>
                                <th class="text-amber-400">TGL MASUK MESS</th>
                                <th class="sticky-col-right text-center">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB MANAJEMEN DATA -->
            <div id="tab-manajemen-data" class="hidden absolute inset-0 p-8 overflow-y-auto custom-scrollbar animate-in fade-in duration-500">
                <div class="max-w-6xl mx-auto">
                    <h3 class="text-2xl font-black text-white mb-2">Manajemen Data Karyawan</h3>
                    <p class="text-slate-400 text-sm mb-8">Kelola data karyawan hunian mess dengan fitur lengkap</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Tambah Data Manual -->
                        <div class="glass-panel p-8 rounded-3xl border-l-4 border-emerald-500">
                            <div class="w-12 h-12 bg-emerald-500/20 text-emerald-500 rounded-xl flex items-center justify-center mb-4">
                                <i data-lucide="user-plus" class="w-6 h-6"></i>
                            </div>
                            <h4 class="text-lg font-black text-white mb-3">Tambah Data Manual</h4>
                            <p class="text-slate-400 text-sm mb-6">Tambahkan data karyawan satu per satu melalui form input yang lengkap.</p>
                            <button onclick="openModal()" class="btn-primary w-full">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> TAMBAH DATA
                            </button>
                        </div>
                        
                        <!-- Import Data Excel -->
                        <div class="glass-panel p-8 rounded-3xl border-l-4 border-sky-500">
                            <div class="w-12 h-12 bg-sky-500/20 text-sky-500 rounded-xl flex items-center justify-center mb-4">
                                <i data-lucide="upload" class="w-6 h-6"></i>
                            </div>
                            <h4 class="text-lg font-black text-white mb-3">Import Data Excel</h4>
                            <p class="text-slate-400 text-sm mb-6">Import data karyawan massal menggunakan file Excel dengan format template.</p>
                            <button onclick="openImportAdvancedModal()" class="btn-primary w-full">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i> IMPORT EXCEL
                            </button>
                        </div>
                        
                        <!-- Export Data -->
                        <div class="glass-panel p-8 rounded-3xl border-l-4 border-amber-500">
                            <div class="w-12 h-12 bg-amber-500/20 text-amber-500 rounded-xl flex items-center justify-center mb-4">
                                <i data-lucide="download" class="w-6 h-6"></i>
                            </div>
                            <h4 class="text-lg font-black text-white mb-3">Export Data</h4>
                            <p class="text-slate-400 text-sm mb-6">Export seluruh data karyawan ke file Excel untuk backup atau analisis.</p>
                            <button onclick="exportData()" class="btn-primary w-full">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i> EXPORT DATA
                            </button>
                        </div>
                    </div>
                    
                    <!-- Template Download Section -->
                    <div class="glass-panel p-8 rounded-3xl mb-8">
                        <h4 class="text-lg font-black text-white mb-4">Download Template Import</h4>
                        <p class="text-slate-400 text-sm mb-6">Unduh template Excel untuk memudahkan pengisian data sebelum diimport ke sistem.</p>
                        <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-emerald-500/20 text-emerald-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h5 class="text-sm font-bold text-white">Template_Import_OceanMess.xlsx</h5>
                                    <p class="text-[10px] text-slate-400">Format Excel dengan petunjuk pengisian</p>
                                </div>
                            </div>
                            <button onclick="downloadTemplate()" class="btn-secondary">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i> UNDUH
                            </button>
                        </div>
                    </div>
                    
                    <!-- Database Info -->
                    <div class="glass-panel p-8 rounded-3xl">
                        <h4 class="text-lg font-black text-white mb-4">Informasi Database</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Status Koneksi</span>
                                    <span id="db-connection-status" class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">Connected</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Total Data</span>
                                    <span id="db-total-data" class="text-white font-bold">0</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Data Terbaru</span>
                                    <span id="db-latest-update" class="text-slate-400 text-sm">-</span>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Kapasitas Terpakai</span>
                                    <span id="db-capacity-used" class="text-white font-bold">0%</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Lokasi Mess</span>
                                    <span id="db-mess-count" class="text-white font-bold">0</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                                    <span class="text-sm text-slate-400">Versi Aplikasi</span>
                                    <span class="text-slate-400 text-sm">v2.2.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ==================== KONFIGURASI SUPABASE ====================
        const SUPABASE_URL = 'https://ahzfpguvgdjytshlgjfv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoemZwZ3V2Z2RqeXRzaGxnamZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2OTYwOTYsImV4cCI6MjA4MjI3MjA5Nn0.sMgxg6MaWTii-i6Pf84JzM-p2ut__yHG0v0bhurnt74';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==================== VARIABEL GLOBAL ====================
        let employees = [];
        let activeTab = 'dashboard';
        let currentFilter = 'ALL';
        let isSidebarCollapsed = false;
        
        // Variabel untuk Data Karyawan Keseluruhan
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let filteredEmployeesAll = [];
        
        // Variabel untuk Import Advanced
        let importStep = 1;
        let importedData = [];
        let columnMapping = {};
        let fileHeaders = [];
        let validationResults = {
            valid: [],
            invalid: [],
            duplicates: []
        };

        // Mapping GRD untuk display
        const grdMapping = {
            '1': { name: 'Golongan 1', class: 'grd-1', color: 'sky' },
            '2': { name: 'Golongan 2', class: 'grd-2', color: 'emerald' },
            '3': { name: 'Golongan 3', class: 'grd-3', color: 'amber' },
            '4': { name: 'Golongan 4 UP', class: 'grd-4', color: 'purple' },
            'vendor': { name: 'Vendor & Kontraktor', class: 'grd-vendor', color: 'rose' }
        };

        // Field mapping untuk import
        const fieldMapping = {
            'nik': ['NIK', 'NIK Karyawan', 'Nomor Induk', 'No. Induk'],
            'nama': ['NAMA', 'Nama', 'Nama Lengkap', 'Nama Karyawan'],
            'gender': ['GENDER', 'Gender', 'Jenis Kelamin', 'JK'],
            'grd': ['GRD', 'Grade', 'Golongan', 'GOL', 'Kelas'],
            'gol': ['GOL_DETAIL', 'Gol Detail', 'Detail Golongan', 'Sub Golongan'],
            'jabatan': ['JABATAN', 'Jabatan', 'Posisi', 'Position'],
            'department': ['DEPARTMENT', 'Department', 'Divisi', 'Bagian'],
            'fasilitas': ['FASILITAS', 'Fasilitas', 'Tipe Kamar', 'Room Type'],
            'point_of_hire': ['Point of Hire', 'POINT OF HIRE', 'Asal', 'Domisili'],
            'tanggal_masuk_kerja': ['TANGGAL MASUK KERJA', 'Tanggal Masuk Kerja', 'Tgl Masuk', 'Join Date'],
            'perusahaan': ['PERUSAHAAN', 'Perusahaan', 'Company', 'Firma'],
            'lokasi_hunian': ['LOKASI HUNIAN', 'Lokasi Hunian', 'Lokasi Mess', 'Mess'],
            'floor': ['FLOOR', 'Floor', 'Lantai', 'Tingkat'],
            'block': ['BLOCK', 'Block', 'Blok', 'Zona'],
            'no_kamar': ['NO KAMAR', 'No Kamar', 'Nomor Kamar', 'Kamar'],
            'status_kamar': ['STATUS KAMAR', 'Status Kamar', 'Status', 'Kondisi'],
            'tanggal_masuk_mess_hunian_p2': ['TANGGAL MASUK MESS HUNIAN P2', 'Tanggal Masuk Mess', 'Tgl Masuk Mess', 'Check-in Date']
        };

        // ==================== FUNGSI UTAMA ====================

        // Fungsi untuk menampilkan loading
        function showLoading(message = "Memproses data...") {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-detail').textContent = message;
        }

        // Fungsi untuk menyembunyikan loading
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Fungsi validasi NIK
        function isValidNIK(nik) {
            if (!nik || typeof nik !== 'string') return false;
            const cleanNIK = nik.toString().trim().toUpperCase();
            const nikPattern = /^[A-Z][A-Z0-9]{1,19}$/;
            return nikPattern.test(cleanNIK);
        }

        // Format NIK otomatis
        function formatNIK(input) {
            input.value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        // Validasi NIK dengan feedback
        function validateNIK(input) {
            const hint = document.getElementById('nik-hint');
            const error = document.getElementById('nik-error');
            const value = input.value.trim();
            
            if (value === '') {
                hint.classList.add('hidden');
                error.classList.add('hidden');
                return false;
            }
            
            hint.classList.remove('hidden');
            
            if (!isValidNIK(value)) {
                input.classList.remove('validation-success');
                input.classList.add('validation-error');
                error.textContent = 'NIK harus dimulai dengan huruf, diikuti kombinasi huruf dan angka (2-20 karakter)';
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.remove('validation-error');
                input.classList.add('validation-success');
                error.classList.add('hidden');
                return true;
            }
        }

        // Dapatkan nama GRD untuk display
        function getGrdDisplay(grd) {
            return grdMapping[grd]?.name || grd || '-';
        }

        // Dapatkan class untuk badge GRD
        function getGrdClass(grd) {
            return grdMapping[grd]?.class || 'bg-slate-500/10 text-slate-500';
        }

        // ==================== FUNGSI DATABASE ====================

        // Ambil semua data dari database
        async function fetchAllData() {
            showLoading("Memuat data dari database...");
            try {
                const { data, error } = await supabaseClient
                    .from('karyawan_mess')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Error fetching data:", error);
                    showToast("Gagal memuat data: " + error.message, "error");
                    employees = [];
                    document.getElementById('db-connection-status').className = 'px-3 py-1 bg-rose-500/20 text-rose-400 rounded-full text-xs font-bold';
                    document.getElementById('db-connection-status').textContent = 'Disconnected';
                    document.getElementById('db-status').className = 'font-bold text-rose-400';
                    document.getElementById('db-status').textContent = 'Disconnected';
                } else {
                    employees = data || [];
                    showToast(`Data berhasil dimuat: ${employees.length} karyawan`, "success");
                    document.getElementById('db-connection-status').className = 'px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold';
                    document.getElementById('db-connection-status').textContent = 'Connected';
                    document.getElementById('db-status').className = 'font-bold text-emerald-400';
                    document.getElementById('db-status').textContent = 'Connected';
                    
                    // Update database info
                    document.getElementById('db-total-data').textContent = employees.length;
                    if (employees.length > 0) {
                        const latest = new Date(employees[0].created_at);
                        document.getElementById('db-latest-update').textContent = latest.toLocaleDateString('id-ID');
                    }
                }
            } catch (err) {
                console.error("Exception fetching data:", err);
                showToast("Gagal memuat data: " + err.message, "error");
                employees = [];
            } finally {
                hideLoading();
                updateUI();
                populateFilterOptions();
                updateCategoryCounts();
                renderAllEmployeesTable();
            }
        }

        // ==================== FUNGSI MODAL ====================

        // Buka modal untuk tambah/edit data
        function openModal(editData = null) {
            const form = document.getElementById('employeeForm');
            const title = document.getElementById('modal-title');
            
            // Reset form
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('nik-hint').classList.add('hidden');
            document.getElementById('nik-error').classList.add('hidden');
            
            // Set tanggal maksimal ke hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('field-tanggal_masuk_kerja').max = today;
            document.getElementById('field-tanggal_masuk_mess_hunian_p2').max = today;

            if (editData) {
                title.innerText = "Edit Data Karyawan";
                document.getElementById('edit-id').value = editData.id;
                
                // Isi semua field dengan data yang ada
                const fields = [
                    'nik', 'nama', 'gender', 'grd', 'gol', 'jabatan', 'department', 'perusahaan',
                    'lokasi_hunian', 'floor', 'block', 'no_kamar', 'fasilitas', 'point_of_hire',
                    'status_kamar', 'tanggal_masuk_kerja', 'tanggal_masuk_mess_hunian_p2'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(`field-${field}`);
                    if (element && editData[field]) {
                        element.value = editData[field];
                    }
                });
                
                // Validasi NIK
                validateNIK(document.getElementById('field-nik'));
            } else {
                title.innerText = "Tambah Data Karyawan";
                // Set tanggal default ke hari ini
                document.getElementById('field-tanggal_masuk_kerja').value = today;
                document.getElementById('field-tanggal_masuk_mess_hunian_p2').value = today;
                document.getElementById('field-status_kamar').value = 'TERISI';
            }
            
            document.getElementById('modal-form').classList.remove('hidden');
        }

        // Tutup modal form
        function closeModal() { 
            document.getElementById('modal-form').classList.add('hidden');
            document.getElementById('nik-hint').classList.add('hidden');
            document.getElementById('nik-error').classList.add('hidden');
        }

        // Buka modal import advanced
        function openImportAdvancedModal() {
            document.getElementById('modal-import-advanced').classList.remove('hidden');
            resetImportSteps();
        }

        // Tutup modal import advanced
        function closeImportAdvancedModal() {
            document.getElementById('modal-import-advanced').classList.add('hidden');
            resetImportSteps();
        }

        // Reset semua step import
        function resetImportSteps() {
            importStep = 1;
            importedData = [];
            columnMapping = {};
            fileHeaders = [];
            validationResults = {
                valid: [],
                invalid: [],
                duplicates: []
            };
            
            // Reset UI
            goToStep(1);
        }

        // ==================== FUNGSI NAVIGASI ====================

        // Ganti tab utama
        function switchTab(tab) {
            activeTab = tab;
            
            // Sembunyikan semua tab
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-data-karyawan-keseluruhan').classList.add('hidden');
            document.getElementById('tab-data-karyawan').classList.add('hidden');
            document.getElementById('tab-manajemen-data').classList.add('hidden');
            
            // Tampilkan tab yang dipilih
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            // Update header
            const titles = {
                'dashboard': 'Dashboard',
                'data-karyawan-keseluruhan': 'Data Karyawan Keseluruhan',
                'data-karyawan': 'Data Karyawan',
                'manajemen-data': 'Manajemen Data'
            };
            
            const subtitles = {
                'dashboard': 'Sistem Manajemen Mess Terintegrasi',
                'data-karyawan-keseluruhan': 'Database Karyawan Lengkap',
                'data-karyawan': 'Database Karyawan Mess P2',
                'manajemen-data': 'Kelola Data Karyawan'
            };
            
            const icons = {
                'dashboard': 'layout-grid',
                'data-karyawan-keseluruhan': 'users',
                'data-karyawan': 'database',
                'manajemen-data': 'settings'
            };
            
            document.getElementById('page-title').innerText = titles[tab];
            document.getElementById('page-subtitle').innerText = subtitles[tab];
            document.getElementById('page-icon').innerHTML = `<i data-lucide="${icons[tab]}"></i>`;
            
            // Update navigation styles
            updateNavStyles();
            
            // Jika tab data karyawan, render tabel
            if (tab === 'data-karyawan') {
                renderTable();
            } else if (tab === 'data-karyawan-keseluruhan') {
                renderAllEmployeesTable();
            }
            
            // Update lucide icons
            lucide.createIcons();
        }

        // Ganti kategori filter berdasarkan GRD
        function switchCategory(grd) {
            activeTab = 'data-karyawan';
            currentFilter = grd;
            
            // Switch ke tab data karyawan
            switchTab('data-karyawan');
            
            // Update nama view berdasarkan GRD
            const grdName = getGrdDisplay(grd);
            document.getElementById('current-view-name').innerText = `DATABASE ${grdName.toUpperCase()}`;
            
            // Update navigation styles
            updateNavStyles();
            
            // Render tabel dengan filter GRD
            renderTable();
        }

        // Update style navigasi
        function updateNavStyles() {
            // Reset semua nav link
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            // Set active berdasarkan tab/kategori
            if (activeTab === 'dashboard') {
                document.getElementById('nav-dashboard').classList.add('active');
            } else if (activeTab === 'data-karyawan-keseluruhan') {
                document.getElementById('nav-data-karyawan-keseluruhan').classList.add('active');
            } else if (activeTab === 'data-karyawan') {
                document.getElementById('nav-data-karyawan').classList.add('active');
                
                // Jika ada filter kategori GRD, aktifkan juga
                const grdMap = {
                    '1': 'nav-gol1',
                    '2': 'nav-gol2', 
                    '3': 'nav-gol3',
                    '4': 'nav-gol4',
                    'vendor': 'nav-vendor'
                };
                
                if (grdMap[currentFilter]) {
                    document.getElementById(grdMap[currentFilter]).classList.add('active');
                }
            } else if (activeTab === 'manajemen-data') {
                document.getElementById('nav-manajemen-data').classList.add('active');
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('toggle-icon');
            sidebar.classList.toggle('collapsed', isSidebarCollapsed);
            icon.setAttribute('data-lucide', isSidebarCollapsed ? 'chevron-right' : 'chevron-left');
            lucide.createIcons();
        }

        // ==================== FUNGSI DATA KARYAWAN KESELURUHAN ====================

        // Render tabel untuk Data Karyawan Keseluruhan
        function renderAllEmployeesTable() {
            // Apply filters
            applyAllFilters(true);
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredEmployeesAll.length);
            const currentData = filteredEmployeesAll.slice(startIndex, endIndex);
            
            // Update counts
            document.getElementById('data-count-badge-all').innerText = `${filteredEmployeesAll.length} DATA`;
            document.getElementById('filtered-count').textContent = filteredEmployeesAll.length;
            document.getElementById('total-count').textContent = employees.length;
            document.getElementById('page-start').textContent = startIndex + 1;
            document.getElementById('page-end').textContent = endIndex;
            document.getElementById('total-items').textContent = filteredEmployeesAll.length;
            
            // Calculate total pages
            totalPages = Math.ceil(filteredEmployeesAll.length / pageSize);
            
            // Update pagination controls
            updatePaginationControls();
            
            // Render table body
            const tbody = document.getElementById('table-body-all');
            
            if (currentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="18" class="text-center py-12">
                            <i data-lucide="database" class="w-12 h-12 text-slate-600 mx-auto mb-4"></i>
                            <p class="text-slate-500 font-medium">Tidak ada data yang ditemukan</p>
                            <p class="text-slate-600 text-[10px] mt-2">Coba ubah filter pencarian atau tambah data baru</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = currentData.map(e => `
                <tr class="table-row-hover">
                    <td class="sticky-col-left font-mono text-sky-400 font-bold border-r border-white/5">${e.nik || '-'}</td>
                    <td class="text-white font-bold">${e.nama || '-'}</td>
                    <td class="text-slate-400 uppercase">${e.gender || '-'}</td>
                    <td class="text-slate-300 font-medium">${e.department || '-'}</td>
                    <td class="text-center">
                        <span class="grd-badge ${getGrdClass(e.grd)}">${getGrdDisplay(e.grd)}</span>
                    </td>
                    <td class="font-bold text-center"><span class="bg-white/5 px-2 py-1 rounded border border-white/5">${e.gol || '-'}</span></td>
                    <td class="text-slate-400">${e.jabatan || '-'}</td>
                    <td class="text-slate-400 uppercase">${e.fasilitas || '-'}</td>
                    <td class="text-sky-300 font-medium italic">${e.point_of_hire || '-'}</td>
                    <td class="text-slate-400">${formatDateForDisplay(e.tanggal_masuk_kerja) || '-'}</td>
                    <td class="text-emerald-400 font-bold">${e.perusahaan || '-'}</td>
                    <td class="text-white font-bold uppercase tracking-tighter">${e.lokasi_hunian || '-'}</td>
                    <td class="text-slate-400">${e.floor || '-'}</td>
                    <td class="text-slate-300 font-bold">${e.block || '-'}</td>
                    <td class="text-emerald-400 font-black">${e.no_kamar || '-'}</td>
                    <td><span class="px-3 py-1 rounded-full text-[9px] font-bold ${getStatusClass(e.status_kamar)}">${e.status_kamar || 'TERISI'}</span></td>
                    <td class="text-amber-400 font-bold">${formatDateForDisplay(e.tanggal_masuk_mess_hunian_p2) || '-'}</td>
                    <td class="sticky-col-right text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick='openModal(${JSON.stringify(e).replace(/'/g, "&apos;")})' class="p-2 bg-sky-500/10 text-sky-500 hover:bg-sky-500 hover:text-white rounded-lg transition-all" title="Edit">
                                <i data-lucide="edit-3" class="w-3.5 h-3.5"></i>
                            </button>
                            <button onclick="deleteEmployee('${e.id}')" class="p-2 bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white rounded-lg transition-all" title="Hapus">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // Apply filters untuk Data Karyawan Keseluruhan
        function applyAllFilters(silent = false) {
            const search = document.getElementById('globalSearch').value.toLowerCase();
            const filterLok = document.getElementById('filterAllLokasi')?.value || '';
            const filterGrd = document.getElementById('filterAllGrd')?.value || '';
            const filterPerusahaan = document.getElementById('filterAllPerusahaan')?.value || '';
            const filterStatus = document.getElementById('filterAllStatus')?.value || '';
            const filterTanggal = document.getElementById('filterAllTanggal')?.value || '';

            filteredEmployeesAll = employees.filter(e => {
                const matchesSearch = (e.nama || "").toLowerCase().includes(search) || 
                                     (e.nik || "").toLowerCase().includes(search) ||
                                     (e.no_kamar || "").toLowerCase().includes(search) ||
                                     (e.department || "").toLowerCase().includes(search);
                const matchesLok = !filterLok || e.lokasi_hunian === filterLok;
                const matchesGrd = !filterGrd || e.grd === filterGrd;
                const matchesPerusahaan = !filterPerusahaan || e.perusahaan === filterPerusahaan;
                const matchesStatus = !filterStatus || e.status_kamar === filterStatus;
                
                // Filter tanggal masuk kerja berdasarkan bulan dan tahun
                let matchesTanggal = true;
                if (filterTanggal) {
                    const tanggal = e.tanggal_masuk_kerja;
                    if (tanggal) {
                        const date = new Date(tanggal);
                        const filterDate = new Date(filterTanggal + '-01');
                        matchesTanggal = date.getFullYear() === filterDate.getFullYear() && 
                                        date.getMonth() === filterDate.getMonth();
                    } else {
                        matchesTanggal = false;
                    }
                }
                
                return matchesSearch && matchesLok && matchesGrd && 
                       matchesPerusahaan && matchesStatus && matchesTanggal;
            });

            // Reset ke halaman pertama
            currentPage = 1;
            
            if (!silent) {
                renderAllEmployeesTable();
                showToast(`Filter diterapkan: ${filteredEmployeesAll.length} data ditemukan`, "success");
            }
        }

        // Reset semua filter
        function resetAllFilters() {
            document.getElementById('filterAllLokasi').value = '';
            document.getElementById('filterAllGrd').value = '';
            document.getElementById('filterAllPerusahaan').value = '';
            document.getElementById('filterAllStatus').value = '';
            document.getElementById('filterAllTanggal').value = '';
            document.getElementById('globalSearch').value = '';
            
            applyAllFilters();
            showToast("Semua filter telah direset", "success");
        }

        // Toggle advanced filter
        function toggleAdvancedFilter() {
            const content = document.getElementById('advanced-filter-content');
            const button = document.getElementById('toggle-filter');
            const icon = button.querySelector('i');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.innerHTML = '<i data-lucide="chevron-up" class="w-3 h-3"></i> SEMBUNYIKAN FILTER';
                lucide.createIcons();
            } else {
                content.classList.add('hidden');
                button.innerHTML = '<i data-lucide="chevron-down" class="w-3 h-3"></i> TAMPILKAN FILTER';
                lucide.createIcons();
            }
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAllEmployeesTable();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderAllEmployeesTable();
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderAllEmployeesTable();
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('page-size').value);
            currentPage = 1;
            renderAllEmployeesTable();
        }

        function updatePaginationControls() {
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            // Update button states
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            // Generate page numbers
            let pageHtml = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    pageHtml += `<button class="w-8 h-8 rounded-lg bg-sky-500 text-white text-[10px] font-bold">${i}</button>`;
                } else {
                    pageHtml += `<button onclick="goToPage(${i})" class="w-8 h-8 rounded-lg hover:bg-white/5 text-slate-400 text-[10px] font-bold">${i}</button>`;
                }
            }
            
            pageNumbers.innerHTML = pageHtml;
        }

        // Export all data
        function exportAllData() {
            if (filteredEmployeesAll.length === 0) {
                showToast("Tidak ada data untuk diexport", "warning");
                return;
            }

            showLoading("Mempersiapkan file export...");
            try {
                // Format data untuk export
                const exportData = filteredEmployeesAll.map(emp => ({
                    NIK: emp.nik || '',
                    NAMA: emp.nama || '',
                    GENDER: emp.gender || '',
                    DEPARTMENT: emp.department || '',
                    GRD: emp.grd || '',
                    GOL: emp.gol || '',
                    JABATAN: emp.jabatan || '',
                    FASILITAS: emp.fasilitas || '',
                    "Point of Hire": emp.point_of_hire || '',
                    "TANGGAL MASUK KERJA": emp.tanggal_masuk_kerja || '',
                    PERUSAHAAN: emp.perusahaan || '',
                    "LOKASI HUNIAN": emp.lokasi_hunian || '',
                    FLOOR: emp.floor || '',
                    BLOCK: emp.block || '',
                    "NO KAMAR": emp.no_kamar || '',
                    "STATUS KAMAR": emp.status_kamar || '',
                    "TANGGAL MASUK MESS HUNIAN P2": emp.tanggal_masuk_mess_hunian_p2 || ''
                }));

                // Buat worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                const colWidths = [
                    { wch: 15 }, { wch: 25 }, { wch: 12 }, { wch: 20 },
                    { wch: 8 }, { wch: 8 }, { wch: 20 }, { wch: 10 },
                    { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 },
                    { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 },
                    { wch: 15 }
                ];
                ws['!cols'] = colWidths;
                
                // Buat workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data Karyawan Keseluruhan");
                
                // Download file
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Data_Karyawan_Keseluruhan_${today}.xlsx`);
                
                showToast(`Export ${filteredEmployeesAll.length} data berhasil`, "success");
            } catch (error) {
                console.error("Export error:", error);
                showToast("Gagal mengexport data: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ==================== FUNGSI IMPORT ADVANCED ====================

        // Navigasi antar step import
        function goToStep(step) {
            // Sembunyikan semua step
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Tampilkan step yang dipilih
            document.getElementById(`step${step}-content`).classList.remove('hidden');
            
            // Update step indicator
            document.querySelectorAll('.step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                }
            });
            
            importStep = step;
        }

        // Handle file select untuk import advanced
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validasi ukuran file
            if (file.size > 10 * 1024 * 1024) {
                showToast("Ukuran file terlalu besar (maksimal 10MB)", "error");
                return;
            }
            
            // Validasi ekstensi file
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExt)) {
                showToast("Format file tidak didukung. Gunakan file Excel (.xlsx, .xls, .csv)", "error");
                return;
            }
            
            showLoading("Membaca file Excel...");
            
            try {
                const data = await readExcelFile(file);
                if (data && data.length > 0) {
                    importedData = data;
                    fileHeaders = Object.keys(data[0]);
                    
                    // Generate automatic column mapping
                    generateAutoMapping();
                    
                    // Enable next button
                    document.getElementById('next-step1').disabled = false;
                    
                    // Go to step 2
                    goToStep(2);
                    populateColumnMapping();
                    
                    showToast(`File berhasil dibaca: ${data.length} baris data`, "success");
                } else {
                    throw new Error("File Excel kosong atau format tidak sesuai");
                }
            } catch (error) {
                console.error("Error reading Excel file:", error);
                showToast("Gagal memproses file: " + error.message, "error");
            } finally {
                hideLoading();
                // Reset input file
                event.target.value = "";
            }
        }

        // Generate automatic column mapping
        function generateAutoMapping() {
            columnMapping = {};
            
            fileHeaders.forEach(header => {
                const headerLower = header.toLowerCase();
                
                // Cari field yang cocok
                for (const [field, possibleNames] of Object.entries(fieldMapping)) {
                    for (const name of possibleNames) {
                        if (headerLower.includes(name.toLowerCase())) {
                            columnMapping[field] = header;
                            break;
                        }
                    }
                    if (columnMapping[field]) break;
                }
                
                // Jika tidak ditemukan mapping, coba tebak berdasarkan nama header
                if (!Object.values(columnMapping).includes(header)) {
                    if (headerLower.includes('nik')) columnMapping.nik = header;
                    else if (headerLower.includes('nama')) columnMapping.nama = header;
                    else if (headerLower.includes('grd') || headerLower.includes('grade')) columnMapping.grd = header;
                    else if (headerLower.includes('kamar')) columnMapping.no_kamar = header;
                }
            });
        }

        // Populate column mapping UI
        function populateColumnMapping() {
            const container = document.getElementById('column-mapping-container');
            let html = '';
            
            for (const [field, possibleNames] of Object.entries(fieldMapping)) {
                const isRequired = ['nik', 'nama', 'grd', 'no_kamar'].includes(field);
                
                html += `
                    <div class="form-group">
                        <label class="form-label ${isRequired ? 'required-field' : ''}">
                            ${field.toUpperCase().replace(/_/g, ' ')}
                            ${isRequired ? ' (WAJIB)' : ''}
                        </label>
                        <select class="select-field w-full" id="map-${field}" onchange="updateColumnMapping('${field}')">
                            <option value="">-- Pilih Kolom --</option>
                            ${fileHeaders.map(header => `
                                <option value="${header}" ${columnMapping[field] === header ? 'selected' : ''}>
                                    ${header}
                                </option>
                            `).join('')}
                        </select>
                        <div class="text-[10px] text-slate-500 mt-1">
                            ${isRequired ? '<i data-lucide="alert-circle" class="w-3 h-3 inline mr-1 text-amber-400"></i>' : ''}
                            ${possibleNames.join(', ')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        // Update column mapping
        function updateColumnMapping(field) {
            const select = document.getElementById(`map-${field}`);
            columnMapping[field] = select.value;
        }

        // Validate and proceed to next step
        async function validateAndProceed() {
            // Validasi kolom wajib
            const requiredFields = ['nik', 'nama', 'grd', 'no_kamar'];
            const missingFields = requiredFields.filter(field => !columnMapping[field]);
            
            if (missingFields.length > 0) {
                showToast(`Kolom wajib belum dipilih: ${missingFields.join(', ')}`, "error");
                return;
            }
            
            showLoading("Memproses dan memvalidasi data...");
            
            try {
                // Proses data dengan mapping yang sudah ditentukan
                const processedData = importedData.map((row, index) => {
                    const processed = { rowNumber: index + 2 };
                    
                    // Map data berdasarkan columnMapping
                    for (const [field, excelColumn] of Object.entries(columnMapping)) {
                        if (excelColumn && row[excelColumn] !== undefined) {
                            processed[field] = row[excelColumn];
                        }
                    }
                    
                    // Validasi data
                    processed.isValid = true;
                    processed.errors = [];
                    processed.action = 'new'; // Default action
                    
                    // Validasi NIK
                    if (!processed.nik) {
                        processed.isValid = false;
                        processed.errors.push("NIK tidak boleh kosong");
                    } else if (!isValidNIK(processed.nik)) {
                        processed.isValid = false;
                        processed.errors.push(`Format NIK tidak valid: "${processed.nik}"`);
                    } else {
                        processed.nik = processed.nik.toString().trim().toUpperCase();
                    }
                    
                    // Cek duplikasi di database
                    const existingEmployee = employees.find(e => e.nik === processed.nik);
                    if (existingEmployee) {
                        processed.action = 'update';
                        processed.existingId = existingEmployee.id;
                    }
                    
                    return processed;
                });
                
                // Kategorikan data
                validationResults.valid = processedData.filter(item => item.isValid);
                validationResults.invalid = processedData.filter(item => !item.isValid);
                validationResults.duplicates = validationResults.valid.filter(item => item.action === 'update');
                
                // Update UI
                updatePreviewTable(validationResults.valid.slice(0, 50)); // Show first 50 rows
                updateValidationSummary();
                
                // Enable next button
                document.getElementById('next-step3').disabled = false;
                
                // Go to step 4
                goToStep(4);
                updateImportSummary();
                
                showToast(`Validasi selesai: ${validationResults.valid.length} data valid, ${validationResults.invalid.length} data tidak valid`, "success");
            } catch (error) {
                console.error("Validation error:", error);
                showToast("Gagal memvalidasi data: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // Update preview table
        function updatePreviewTable(data) {
            const tbody = document.getElementById('preview-table-body-advanced');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-slate-500">
                            Tidak ada data untuk ditampilkan
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(item => `
                <tr class="${item.isValid ? (item.action === 'update' ? 'data-row-update' : 'data-row-valid') : 'data-row-invalid'}">
                    <td class="py-2 px-4 text-slate-500 text-[10px]">${item.rowNumber}</td>
                    <td class="py-2 px-4 font-mono ${item.isValid ? (item.action === 'update' ? 'text-amber-400' : 'text-emerald-400') : 'text-rose-400'} font-bold">${item.nik || '-'}</td>
                    <td class="py-2 px-4 font-medium">${item.nama || '-'}</td>
                    <td class="py-2 px-4 text-center"><span class="grd-badge ${getGrdClass(item.grd)}">${getGrdDisplay(item.grd)}</span></td>
                    <td class="py-2 px-4 font-black">${item.no_kamar || '-'}</td>
                    <td class="py-2 px-4">
                        ${item.isValid ? 
                            (item.action === 'update' ? 
                                '<span class="px-2 py-0.5 rounded text-[8px] font-bold bg-amber-500/10 text-amber-500">UPDATE</span>' : 
                                '<span class="px-2 py-0.5 rounded text-[8px] font-bold bg-emerald-500/10 text-emerald-500">BARU</span>') : 
                            '<span class="px-2 py-0.5 rounded text-[8px] font-bold bg-rose-500/10 text-rose-500">INVALID</span>'}
                    </td>
                    <td class="py-2 px-4 text-center">
                        ${item.isValid ? 
                            '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>' : 
                            '<i data-lucide="x-circle" class="w-4 h-4 text-rose-500"></i>'}
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
        }

        // Update validation summary
        function updateValidationSummary() {
            const container = document.getElementById('validation-summary');
            
            container.innerHTML = `
                <div class="glass-card p-4 rounded-xl border-l-4 border-emerald-500">
                    <div class="text-2xl font-black text-emerald-400">${validationResults.valid.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Valid</div>
                    <div class="text-[8px] text-slate-500 mt-1">Siap diimport</div>
                </div>
                <div class="glass-card p-4 rounded-xl border-l-4 border-rose-500">
                    <div class="text-2xl font-black text-rose-400">${validationResults.invalid.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Invalid</div>
                    <div class="text-[8px] text-slate-500 mt-1">Akan dilewati</div>
                </div>
                <div class="glass-card p-4 rounded-xl border-l-4 border-amber-500">
                    <div class="text-2xl font-black text-amber-400">${validationResults.duplicates.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Update</div>
                    <div class="text-[8px] text-slate-500 mt-1">Akan diupdate</div>
                </div>
            `;
        }

        // Update import summary
        function updateImportSummary() {
            const container = document.getElementById('import-summary');
            
            container.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl font-black text-emerald-400">${validationResults.valid.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Total Data</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-black text-sky-400">${validationResults.valid.length - validationResults.duplicates.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Baru</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-black text-amber-400">${validationResults.duplicates.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Update</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-black text-rose-400">${validationResults.invalid.length}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Data Invalid</div>
                </div>
            `;
        }

        // Start import process
        async function startImportProcess() {
            if (validationResults.valid.length === 0) {
                showToast("Tidak ada data valid untuk diimport", "error");
                return;
            }
            
            const updateExisting = document.getElementById('option-update-existing').checked;
            const skipInvalid = document.getElementById('option-skip-invalid').checked;
            
            // Show progress section
            document.getElementById('import-progress-stats').classList.remove('hidden');
            document.getElementById('progress-stats').classList.remove('hidden');
            
            // Update status
            document.getElementById('import-status-text').textContent = "Memulai proses import...";
            
            showLoading("Memulai proses import...");
            
            try {
                let successCount = 0;
                let errorCount = 0;
                let updateCount = 0;
                let insertCount = 0;
                
                // Filter data berdasarkan opsi
                let dataToProcess = validationResults.valid;
                if (!updateExisting) {
                    dataToProcess = dataToProcess.filter(item => item.action !== 'update');
                }
                
                // Process in chunks
                const chunkSize = 20;
                const chunks = [];
                for (let i = 0; i < dataToProcess.length; i += chunkSize) {
                    chunks.push(dataToProcess.slice(i, i + chunkSize));
                }
                
                // Process each chunk
                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    const start = i * chunkSize + 1;
                    const end = Math.min((i + 1) * chunkSize, dataToProcess.length);
                    
                    // Update progress
                    const progress = ((i + 1) / chunks.length) * 100;
                    document.getElementById('import-progress-fill').style.width = `${progress}%`;
                    document.getElementById('import-status-text').textContent = 
                        `Mengimport data ${start}-${end} dari ${dataToProcess.length}...`;
                    
                    // Update progress stats
                    document.getElementById('progress-stats').innerHTML = `
                        <div class="progress-stat">
                            <div class="progress-stat-value text-sky-400">${successCount + chunk.length}</div>
                            <div class="progress-stat-label">Diproses</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value text-emerald-400">${insertCount}</div>
                            <div class="progress-stat-label">Insert</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value text-amber-400">${updateCount}</div>
                            <div class="progress-stat-label">Update</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-value text-rose-400">${errorCount}</div>
                            <div class="progress-stat-label">Error</div>
                        </div>
                    `;
                    
                    // Prepare chunk data
                    const chunkData = chunk.map(item => {
                        const { rowNumber, isValid, errors, action, existingId, ...cleanData } = item;
                        
                        // Clean and format data
                        if (cleanData.grd) cleanData.grd = cleanData.grd.toString().toLowerCase();
                        if (cleanData.gender) cleanData.gender = cleanData.gender.toUpperCase();
                        if (cleanData.status_kamar) cleanData.status_kamar = cleanData.status_kamar.toUpperCase();
                        if (cleanData.lokasi_hunian) cleanData.lokasi_hunian = cleanData.lokasi_hunian.toUpperCase();
                        if (cleanData.block) cleanData.block = cleanData.block.toUpperCase();
                        
                        return cleanData;
                    });
                    
                    try {
                        // Use upsert for batch operation
                        const { data, error } = await supabaseClient
                            .from('karyawan_mess')
                            .upsert(chunkData, {
                                onConflict: 'nik',
                                ignoreDuplicates: false
                            });
                        
                        if (error) {
                            throw new Error(`Chunk ${i + 1}: ${error.message}`);
                        }
                        
                        // Count results
                        const insertItems = chunk.filter(item => item.action === 'new');
                        const updateItems = chunk.filter(item => item.action === 'update');
                        
                        insertCount += insertItems.length;
                        updateCount += updateItems.length;
                        successCount += chunk.length;
                        
                    } catch (chunkError) {
                        console.error(`Error importing chunk ${i + 1}:`, chunkError);
                        errorCount += chunk.length;
                        
                        // Try individual inserts if batch fails
                        for (const item of chunk) {
                            try {
                                const cleanItem = { ...item };
                                delete cleanItem.rowNumber;
                                delete cleanItem.isValid;
                                delete cleanItem.errors;
                                delete cleanItem.action;
                                delete cleanItem.existingId;
                                
                                const { error } = await supabaseClient
                                    .from('karyawan_mess')
                                    .upsert([cleanItem], {
                                        onConflict: 'nik',
                                        ignoreDuplicates: false
                                    });
                                
                                if (error) {
                                    console.error(`Error importing item ${item.nik}:`, error);
                                } else {
                                    successCount++;
                                    errorCount--;
                                    if (item.action === 'new') insertCount++;
                                    else updateCount++;
                                }
                            } catch (singleError) {
                                console.error(`Error importing single item ${item.nik}:`, singleError);
                            }
                        }
                    }
                }
                
                // Final update
                document.getElementById('import-progress-fill').style.width = '100%';
                document.getElementById('import-status-text').textContent = "Import selesai!";
                document.querySelector('.status-indicator').className = 'status-indicator status-success';
                document.querySelector('.status-indicator span').textContent = 'Selesai';
                
                // Update final stats
                document.getElementById('progress-stats').innerHTML = `
                    <div class="progress-stat">
                        <div class="progress-stat-value text-sky-400">${successCount}</div>
                        <div class="progress-stat-label">Sukses</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value text-emerald-400">${insertCount}</div>
                        <div class="progress-stat-label">Insert</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value text-amber-400">${updateCount}</div>
                        <div class="progress-stat-label">Update</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value text-rose-400">${errorCount}</div>
                        <div class="progress-stat-label">Error</div>
                    </div>
                `;
                
                // Show success message
                if (errorCount > 0) {
                    showToast(`Import sebagian berhasil: ${successCount} data diproses, ${errorCount} error`, "warning");
                } else {
                    showToast(`Import berhasil: ${insertCount} data baru, ${updateCount} data diupdate`, "success");
                }
                
                // Refresh data
                setTimeout(async () => {
                    await fetchAllData();
                    closeImportAdvancedModal();
                }, 2000);
                
            } catch (error) {
                console.error("Import error:", error);
                showToast("Gagal mengimport data: " + error.message, "error");
                document.querySelector('.status-indicator').className = 'status-indicator status-error';
                document.querySelector('.status-indicator span').textContent = 'Error';
            } finally {
                hideLoading();
            }
        }

        // ==================== FUNGSI UMUM ====================

        // Baca file Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { 
                            type: 'array', 
                            cellDates: true,
                            raw: false,
                            dateNF: 'yyyy-mm-dd'
                        });
                        
                        const sheetNames = workbook.SheetNames;
                        if (sheetNames.length === 0) {
                            reject(new Error("File Excel tidak memiliki sheet"));
                            return;
                        }
                        
                        const firstSheetName = sheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            defval: "",
                            raw: false,
                            dateNF: 'yyyy-mm-dd'
                        });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error(`Gagal membaca file Excel: ${error.message}`));
                    }
                };
                reader.onerror = (error) => reject(new Error(`Gagal membaca file: ${error.message}`));
                reader.readAsArrayBuffer(file);
            });
        }

        // Download template
        function downloadTemplate() {
            // Header untuk template
            const headers = [
                ["NIK", "NAMA", "GENDER", "DEPARTMENT", "GRD", "GOL", "JABATAN", "FASILITAS", "Point of Hire", "TANGGAL MASUK KERJA", "PERUSAHAAN", "LOKASI HUNIAN", "FLOOR", "BLOCK", "NO KAMAR", "STATUS KAMAR", "TANGGAL MASUK MESS HUNIAN P2"],
                ["EMP001", "John Doe", "LAKI-LAKI", "IT", "1", "3", "Staff", "CR", "Jakarta", "2023-01-15", "PT. HJF", "P2 SURYA RESIDANCE", "Lantai Bawah", "B", "201", "TERISI", "2023-01-20"],
                ["KRY1001", "Jane Smith", "PEREMPUAN", "HR", "2", "2", "Supervisor", "NR", "Surabaya", "2023-02-01", "PT. HJF", "MENTARI", "Lantai Atas", "A", "105", "TERISI", "2023-02-05"],
                ["VND001", "Michael Brown", "LAKI-LAKI", "MAINTENANCE", "vendor", "VENDOR", "Technician", "CR", "Bandung", "2023-03-10", "VENDOR LAINNYA", "PELANGI", "Lantai Bawah", "C", "305", "TERISI", "2023-03-12"]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(headers);
            const colWidths = [
                { wch: 15 }, { wch: 25 }, { wch: 12 }, { wch: 20 },
                { wch: 8 }, { wch: 8 }, { wch: 20 }, { wch: 10 },
                { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 },
                { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 },
                { wch: 15 }
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Import");
            
            // Sheet petunjuk
            const instructions = [
                ["PETUNJUK PENGISIAN TEMPLATE IMPORT OCEAN MESS"],
                [""],
                ["FORMAT NIK (WAJIB DIPERHATIKAN):"],
                ["• NIK harus dimulai dengan HURUF (A-Z)"],
                ["• Dapat diikuti kombinasi huruf dan angka"],
                ["• Panjang minimal 2 karakter, maksimal 20 karakter"],
                ["• Contoh format NIK yang VALID:"],
                ["  - EMP001, KRY1001, A12345, AB1234"],
                ["• Contoh format NIK yang TIDAK VALID:"],
                ["  - 12345, 1A2345 (dimulai dengan angka)"],
                [""],
                ["KOLOM WAJIB DIISI:"],
                ["• NIK, NAMA, GRD, NO KAMAR"],
                [""],
                ["FORMAT DATA YANG DISESUAIKAN:"],
                ["1. GENDER: LAKI-LAKI atau PEREMPUAN"],
                ["2. GRD (Grade): 1, 2, 3, 4, vendor"],
                ["3. STATUS KAMAR: TERISI, TERSEDIA, RUSAK, DIPERBAIKI"],
                ["4. LOKASI HUNIAN: P2 SURYA RESIDANCE, MENTARI, PELANGI"],
                ["5. FASILITAS: CR, NR"],
                ["6. TANGGAL: Format YYYY-MM-DD"],
                [""],
                ["CATATAN:"],
                ["• Data dengan NIK yang sudah ada akan diupdate"],
                ["• Pastikan format kolom sesuai dengan contoh"],
                ["• Maksimal ukuran file: 10MB"]
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(instructions);
            ws2['!cols'] = [{ wch: 100 }];
            XLSX.utils.book_append_sheet(wb, ws2, "Petunjuk Pengisian");
            
            XLSX.writeFile(wb, "Template_Import_OceanMess_Advanced.xlsx");
            showToast("Template berhasil diunduh", "success");
        }

        // Export data
        function exportData() {
            if (employees.length === 0) {
                showToast("Tidak ada data untuk diexport", "warning");
                return;
            }

            showLoading("Mempersiapkan file export...");
            try {
                const exportData = employees.map(emp => ({
                    NIK: emp.nik || '',
                    NAMA: emp.nama || '',
                    GENDER: emp.gender || '',
                    DEPARTMENT: emp.department || '',
                    GRD: emp.grd || '',
                    GOL: emp.gol || '',
                    JABATAN: emp.jabatan || '',
                    FASILITAS: emp.fasilitas || '',
                    "Point of Hire": emp.point_of_hire || '',
                    "TANGGAL MASUK KERJA": emp.tanggal_masuk_kerja || '',
                    PERUSAHAAN: emp.perusahaan || '',
                    "LOKASI HUNIAN": emp.lokasi_hunian || '',
                    FLOOR: emp.floor || '',
                    BLOCK: emp.block || '',
                    "NO KAMAR": emp.no_kamar || '',
                    "STATUS KAMAR": emp.status_kamar || '',
                    "TANGGAL MASUK MESS HUNIAN P2": emp.tanggal_masuk_mess_hunian_p2 || ''
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const colWidths = [
                    { wch: 15 }, { wch: 25 }, { wch: 12 }, { wch: 20 },
                    { wch: 8 }, { wch: 8 }, { wch: 20 }, { wch: 10 },
                    { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 },
                    { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 },
                    { wch: 15 }
                ];
                ws['!cols'] = colWidths;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Database Mess");
                
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Database_Mess_Export_${today}.xlsx`);
                
                showToast(`Export ${employees.length} data berhasil`, "success");
            } catch (error) {
                console.error("Export error:", error);
                showToast("Gagal mengexport data: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // Fungsi-fungsi yang sudah ada (dari kode sebelumnya) tetap dipertahankan
        // ... (sisanya tetap sama seperti sebelumnya)

        // ==================== INISIALISASI APLIKASI ====================

        window.onload = function() {
            lucide.createIcons();
            
            // Setup event listeners
            document.getElementById('importFile').addEventListener('change', handleFileSelect);
            document.getElementById('globalSearch').addEventListener('input', handleGlobalSearch);
            
            // NIK validation
            const nikField = document.getElementById('field-nik');
            if (nikField) {
                nikField.addEventListener('focus', function() {
                    document.getElementById('nik-hint').classList.remove('hidden');
                });
                
                nikField.addEventListener('blur', function() {
                    validateNIK(this);
                });
            }
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // Load initial data
            fetchAllData();
            
            // Set tanggal maksimal
            const today = new Date().toISOString().split('T')[0];
            const dateFields = ['field-tanggal_masuk_kerja', 'field-tanggal_masuk_mess_hunian_p2'];
            dateFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.max = today;
            });
        };

        // Setup drag and drop
        function setupDragAndDrop() {
            const dropArea = document.getElementById('drag-drop-area');
            
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    document.getElementById('importFile').files = e.dataTransfer.files;
                    const event = new Event('change');
                    document.getElementById('importFile').dispatchEvent(event);
                }
            });
            
            dropArea.addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
        }

        // Handle global search
        function handleGlobalSearch() {
            if (activeTab === 'data-karyawan') {
                renderTable();
            } else if (activeTab === 'data-karyawan-keseluruhan') {
                applyAllFilters();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + N untuk tambah data
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openModal();
            }
            
            // Ctrl + F untuk fokus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            
            // Ctrl + E untuk export
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                if (activeTab === 'data-karyawan-keseluruhan') {
                    exportAllData();
                } else {
                    exportData();
                }
            }
            
            // Ctrl + I untuk import
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                openImportAdvancedModal();
            }
            
            // Esc untuk tutup modal
            if (e.key === 'Escape') {
                if (!document.getElementById('modal-form').classList.contains('hidden')) {
                    closeModal();
                }
                if (!document.getElementById('modal-import-advanced').classList.contains('hidden')) {
                    closeImportAdvancedModal();
                }
            }
        });
    </script>
</body>
</html>
